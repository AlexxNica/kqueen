"use strict";function topology_graph(t,e,n){function a(t){y=t,b.selectAll("g").classed("selected",function(e){return e.item===t})}function r(){p=null,d=l.node().clientWidth,u=l.node().clientHeight,k.size([d,u]),b.attr("viewBox","0 0 "+d+" "+u),i()}function i(){S=b.selectAll("line").data(g),S.exit().remove(),S.enter().insert("line",":first-child"),S.attr("class",function(t){return t.kinds}),R=b.selectAll("g").data(x,function(t){return t.id}),R.exit().remove();var t=R.enter().append("g").call(w);return a(y),k.nodes(x).links(g).start(),t}function o(){var t=x,e=h;x=[],g=[],h={};var n,a,r,o;for(a in f)n=f[a],r=n.kind,s&&!s[r]||(o=t[e[a]],o||(o=cache[a],delete cache[a],o||(o={})),o.id=a,o.item=n,h[a]=x.length,x.push(o));var c,l,m,p,y;for(c=0,l=v.length;c<l;c++)m=v[c],p=h[m.source],y=h[m.target],void 0!==p&&void 0!==y&&g.push({source:p,target:y,kinds:x[p].item.kind+x[y].item.kind});return d&&u?i():d3.select()}function c(){window.clearTimeout(p),p=window.setTimeout(r,150)}var d,u,l=d3.select(t),s=n.kinds,f=[],v=[],m=20;n.radius&&(m=n.radius);var p,x=[],g=[],h={},y=null,k=n.force;k||(k=d3.layout.force().charge(-800).gravity(.2).linkDistance(80));var w=k.drag(),b=l.append("svg").attr("viewBox","0 0 1600 1200").attr("preserveAspectRatio","xMidYMid meet").attr("class","kube-topology"),R=d3.select(),S=d3.select();return k.on("tick",function(){S.attr("x1",function(t){return t.source.x}).attr("y1",function(t){return t.source.y}).attr("x2",function(t){return t.target.x}).attr("y2",function(t){return t.target.y}),R.attr("cx",function(t){return t.x=t.fixed?t.x:Math.max(m,Math.min(d-m,t.x)),t.x}).attr("cy",function(t){return t.y=t.fixed?t.y:Math.max(m,Math.min(u-m,t.y)),t.y}).attr("transform",function(t){return"translate("+t.x+","+t.y+")"})}),w.on("dragstart",function(t){e(t.item),!0!==t.fixed&&(t.floatpoint=[t.x,t.y]),t.fixed=!0,d3.select(this).classed("fixed",!0)}).on("dragend",function(t){var e=!0;t.floatpoint&&(e=t.x<t.floatpoint[0]-5||t.x>t.floatpoint[0]+5||t.y<t.floatpoint[1]-5||t.y>t.floatpoint[1]+5,delete t.floatpoint),t.fixed=e&&t.x>3&&t.x<d-3&&t.y>=3&&t.y<u-3,d3.select(this).classed("fixed",t.fixed)}),b.on("dblclick",function(){b.selectAll("g").classed("fixed",!1).each(function(t){t.fixed=!1}),k.start()}).on("click",function(t){d3.select(d3.event.target).datum()||e(null)}),r(),c(),{select:a,kinds:function(t){s=t;var e=o();return[R,e]},data:function(t,e){f=t||{},v=e||[];var n=o();return[R,n]},close:function(){window.removeEventListener("resize",c),window.clearTimeout(p);var t,e;cache={};for(t in h)e=x[h[t]],delete e.item,cache[t]=e;x=[],h={}}}}function topology_data_transform(t){var e=[],n=t.reduce(function(t,e){return t[e.metadata.uid]=e,t},{}),a=void 0;for(a in n)if(a=n[a],"Pod"===a.kind){var r=!0,i=!1,o=void 0;try{for(var c,d=a.spec.containers[Symbol.iterator]();!(r=(c=d.next()).done);r=!0){var u=c.value,l=a.metadata.uid+"-"+u.name;n[l]={},n[l].metadata=u,n[l].kind="Container",e.push({target:l,source:a.metadata.uid})}}catch(t){i=!0,o=t}finally{try{!r&&d.return&&d.return()}finally{if(i)throw o}}}var s=void 0,f=void 0,v=!0,m=!1,p=void 0;try{for(var x,g=t[Symbol.iterator]();!(v=(x=g.next()).done);v=!0)if(s=x.value,f=s.kind,"Pod"===f&&function(){var n=s,a=t.find(function(t){return t.metadata.name===n.spec.nodeName});if(a?e.push({source:n.metadata.uid,target:a.metadata.uid}):console.log("Cannot found pods node!"),n.metadata.ownerReferences){var r=n.metadata.ownerReferences[0].uid,i=t.find(function(t){return t.metadata.uid===r});e.push({target:n.metadata.uid,source:i.metadata.uid})}else console.log("Cannot found owner references!");var o=t.find(function(t){if("Service"===t.kind&&t.spec.selector)return t.spec.selector.run===n.metadata.labels.run});e.push({target:n.metadata.uid,source:o.metadata.uid})}(),"Service"===f);}catch(t){m=!0,p=t}finally{try{!v&&g.return&&g.return()}finally{if(m)throw p}}return{items:n,relations:e}}var cache={},KubeTopologyVisualization={init:function(t){$(document).on("shown.bs.tab","a[href='#topology']",function(e){d3.json(t,function(t){function e(t){i.select(t)}function n(t){return r[t.item.kind]}function a(t){var e=t.item.status;return!(!e||!e.phase||"Running"===e.phase)}var r=(d3.select("#topology-graph"),{Pod:"#vertex-Pod",ReplicationController:"#vertex-ReplicationController",Node:"#vertex-Node",Service:"#vertex-Service",ReplicaSet:"#vertex-ReplicaSet",Container:"#vertex-Container"}),i=topology_graph("#topology-graph",e,{kinds:r});!function(t){var e=t[0],r=t[1];r.attr("class",function(t){return t.item.kind}),r.append("use").attr("xlink:href",n),r.append("title"),e.selectAll("title").text(function(t){return t.item.metadata.name}),e.classed("weak",a),i.select()}(i.data(t.items,t.relations))})})}};