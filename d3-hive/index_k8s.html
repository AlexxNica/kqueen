<!DOCTYPE html>
<meta charset="utf-8">
<style>
  .link{
    fill: none;
    stroke-width: 1.5px;
  }

  .axis {
    stroke: #666;
  }

  .axis, .node{
    fill: #fff;
    stroke-width: 1.5px;
  }

  .tooltip{
    position: absolute;
    padding: 5px 10px;
    font: 12px sans-serif;
    background: #fff;
    border: 1px solid #000;
    pointer-events: none;
  }

  /*.link:hover{
    stroke: red;
    stroke-opacity:.9;
  }*/
</style>
 <link href="./mdi.css" media="all" rel="stylesheet" type="text/css" />
<body>
<script src="./d3.js"></script>
<script src="./d3.hive.js"></script>
<script src="./k8s.data.js"></script>
<script>

Math.radians = function(degrees) {
  return degrees * Math.PI / 180;
};

// Converts from radians to degrees.
Math.degrees = function(radians) {
  return radians * 180 / Math.PI;
};

console.log(clusterData);

var width = 960;
var height = 600;
var outerRadius = 240;
var innerRadius = 40;

// number of axes
var data_domains = 4;


var data_axes = [
  {x: 0, angle: -45, outer_radius: 240, name:"Pods", kind: "Pod"},
  {x: 1, angle: 45, outer_radius: 240, name:"Nodes", kind: "Node"},
  {x: 2, angle: 135, outer_radius: 240, name:"Services", kind: "Service"},
  {x: 3, angle: 225, outer_radius: 240, name:"Other", kind: "Other"}
]

var axis_mapping = {
  Pod: 0, // engine
  Node: 1, // server
  Service: 2, // web
  Other: 3 // other services
}

var icon_mapping = {
  Pod: "\uf1fb", // engine
  Node: "\uf48b", // server
  Service: "\uf59f", // web
  Other: "\uf59f" // other services
}

var color_mapping = {
  Pod: "red",
  Node: "green",
  Service: "orange",
  Other: "black"
}

var _counters={Service:0,Pod:0, Node:0, Other:0}
var nodes = Object.values(clusterData.items).map(function(item){
  item["id"] = item.metadata.uid;
  if(["Pod","Service","Node"].indexOf(item.kind) < 0){
    item.kind = "Other"
  }
  item["x"] = axis_mapping[item.kind];
  _counters[item.kind]++
  item["y"] = 0.15*_counters[item.kind];
  return item;
});
var links = clusterData.relations.map(function(link){
  var retLink = {};
  nodes.forEach(function(node){
    if(link.source == node.id){
      retLink.source = node;
    } else if(link.target == node.id){
      retLink.target = node;
    }
  });
  if(!retLink.hasOwnProperty("source") || !retLink.hasOwnProperty("target")){
    console.log("Cannot found relation node for link " + link);
    retLink = link;
  }
  return retLink;
});

console.log(nodes);
console.log(links);

var angle = function(i) {
  var angle = 0;
  data_axes.forEach(function(item) {
    if (i.kind == item.kind) {
      angle = item.angle;
    }
  });
  return angle
}
var angle2 = d3.scalePoint().domain(d3.range(data_domains+1)).range([0, 2 * Math.PI]);
var radius = d3.scaleLinear().range([innerRadius, outerRadius]);
var icon = function(i) { return icon_mapping[i] };
var color = function(i) { return color_mapping[i] };

var node_functions = {
  over: function(d) {
    tooltip.transition()
      .duration(200)
      .style("opacity", .9);
    tooltip.html("Node - " + d.name + "<br/>" + "Kind - " + d.kind)
      .style("left", (d3.event.pageX + 5) + "px")
      .style("top", (d3.event.pageY - 28) + "px");
  },
  out: function(d){
    tooltip.transition()
      .duration(500)
      .style("opacity", 0);
  }
};

var svg = d3.select("body")
  .append("svg")
    .attr("width", width)
    .attr("height", height)
  .append("g")
    .attr("transform", "translate(" + width/2 + "," + height/2 + ")");

var tooltip = d3.select("body").append("div")
  .attr("class", "tooltip")
  .style("opacity", 0);

// Hive plot render

axes = svg.selectAll(".node").data(data_axes)
  .enter().append("g")

axes.append("line")
  .attr("class", "axis")
  .attr("transform", function(d){
      return "rotate(" + d.angle + ")";
  })
  .attr("x1", radius.range()[0])
  .attr("x2", radius.range()[1]);

axes.append("text")
  .attr("class", "axis-label")
  .attr('font-size', function(d) { return '18px'; } )
  .attr('text-anchor', 'middle')
  .attr('alignment-baseline', 'central')
  .text(function(d) { return d.name; })
  .attr("transform", function(d) {
    x = (radius.range()[1] + 20) * Math.cos(Math.radians(d.angle));
    y = (radius.range()[1] + 20) * Math.sin(Math.radians(d.angle));
    return "translate(" + x + ", " + y + ")";
  });

svg.selectAll(".link").data(links)
  .enter().append("path")
    .attr("class", "link")
    .attr("d", d3.hive.link()
    .angle(function(d) { return angle(d); })
    .radius(function(d) { return radius(d.y); }))
    .style("stroke", function(d) { return color(d.source.kind); })


nodes = svg.selectAll(".node").data(nodes)
  .enter().append("g")
    .attr("transform", function(d) {
      x = radius(d.y) * Math.cos(Math.radians(angle(d)));
      y = radius(d.y) * Math.sin(Math.radians(angle(d)));
      return "translate(" + x + ", " + y + ")";
    });

nodes.append("circle")
  .attr("r", 16)
  .attr("class", "node")
  .style("stroke", function(d) { return color(d.kind); })
  .on("mouseover", node_functions.over)
  .on("mouseout", node_functions.out);

nodes.append("text")
  .attr('font-family', 'Material Design Icons')
  .attr("color", function(d) { return color(d.kind); })
  .attr('font-size', function(d) { return '18px'; } )
  .text(function(d) { return icon(d.kind); })
  .attr("transform", "translate(-9, 6)")
  .on("mouseover", node_functions.over)
  .on("mouseout", node_functions.out);

</script>